+++
title = "2018-05 Yocto"
type="slide"

theme = "league"
[revealOptions]
transition= 'concave'
controls= true
progress= true
history= true
center= true
+++

# Structure - Overview

___

## Input

1. Bitbake reads a series of conf files to determine which other conf files,
   layers, and global variables to use.
2. Bitbake uses variables from these conf files to determine where to look for
   recipes, recipes appends, classes and includes.

___

## Caching

- [Downloads](https://www.yoctoproject.org/docs/latest/mega-manual/mega-manual.html#structure-build-downloads)
  stores the output of the 'fetch' task and is used as an input to the 'unpack'
  task.
- [Shared State Cache](https://www.yoctoproject.org/docs/latest/mega-manual/mega-manual.html#structure-build-sstate-cache)
  stores the results of tasks which than can be used instead of rerunning the
  task in some scenarios. Read the manual for more information about
  [Shared State](https://www.yoctoproject.org/docs/latest/mega-manual/mega-manual.html#shared-state).

___

## Output

1. Everything under the
   [build directory](https://www.yoctoproject.org/docs/latest/mega-manual/mega-manual.html#structure-build)
   should be considered disposable.
2. The configuration files in build/conf should be generated before bitbake is
   run.
3. By default the caching directories mentioned above are also in the build
   directory.

---

# Input - Bitbake

___

## env - init-build-env

- BBPATH: List of base paths that bitbake will search.
- BB_ENV_EXTRAWHITE: Only certain varibles affect build.
- BUILDDIR: Many variables are defined relative to this path.
- PATH: Add bitbake/bin and poky/scripts.
- PWD: Change Directory into $BUILDDIR

[demo/oe-init-build-env](/demo/oe-init-build-env)

___

## conf - bblayers

Configure inputs to Bitbake

- BBPATH: List of base paths that bitbake will search.
- BBFILES: List of recipe files used by BitBake.
- BBLAYERS: List of paths to layers.

```
# ${BUILDDIR}/conf/bblayer.conf
BBPATH = "${TOPDIR}"
BBFILES ?= ""
BBLAYERS ?= " \
  /tmp/poky/meta \
  /tmp/poky/meta-poky \
  /tmp/poky/meta-yocto-bsp \
  "
```

___

## conf - layer

Configure additional inputs to Bitbake

- BBPATH: List of base paths that bitbake will search.
- BBFILES: List of recipe files used by BitBake.

```
# ${LAYERDIR}/conf/layer.conf
BBPATH .= ":${LAYERDIR}"
BBFILES += "${LAYERDIR}/recipes-*/*/*.bb \
            ${LAYERDIR}/recipes-*/*/*.bbappend"
```

---

# Input - Variables

___

## conf - bitbake.conf

1. Defines 90% of the "magic" variables.
2. Configures sane defaults.
3. Includes other 'conf' files.

This exert shows how the other 'conf' are included.
```
# meta/conf/bitbake.conf
include conf/site.conf
include conf/auto.conf
include conf/local.conf
include conf/machine/${MACHINE}.conf
include conf/machine-sdk/${SDKMACHINE}.conf
include conf/distro/${DISTRO}.conf
include conf/distro/defaultsetup.conf
```

___

## conf - local.conf

Please edit me! This file allows you to quickly and drastically change the
build. Note: All edits should be disposable, but consider designing a
'local.conf.sample' to use as a template (see TEMPLATECONF).

```
# conf/local.conf
MACHINE ??= "qemux86"
DISTRO ?= "poky"
EXTRA_IMAGE_FEATURES ?= "debug-tweaks"
```
___


## conf - distro/machine

Out of scope for this talk.
See [Metadata, Machine Configuration, and Policy Configuration](https://www.yoctoproject.org/docs/latest/mega-manual/mega-manual.html#metadata-machine-configuration-and-policy-configuration).

---

# Input - Recipes

___

## recipe - bb (1/2)

Package recipes provide:

1. Metadata about packages.
2. Instructions to fetch, build and install packages.
3. Additional tasks related to packages.

```bash
# Typical recipe path:
${LAYERDIR}/recipes-${SECTION}/${PN}/${PN}_${PV}.bb
# Typical packages: (in ${TOPDIR}/tmp/deploy/deb/${PACKAGE_ARCH}/)
${PN}_${PV}-${PR}-${DPKG_ARCH}.deb
${PN}-dev_${PV}-${PR}_${DPKG_ARCH}.deb
${PN}-dbg_${PV}-${PR}_${DPKG_ARCH}.deb
```

[[1](https://www.yoctoproject.org/docs/2.5/bitbake-user-manual/bitbake-user-manual.html#recipes)]

___

## recipe - bb (2/2)

Fundamental Blocks:
[variables](https://www.yoctoproject.org/docs/2.5/bitbake-user-manual/bitbake-user-manual.html#basic-syntax)
, [functions](https://www.yoctoproject.org/docs/2.5/bitbake-user-manual/bitbake-user-manual.html#functions)
, and [tasks](https://www.yoctoproject.org/docs/2.5/bitbake-user-manual/bitbake-user-manual.html#tasks)

Features that make recipes awesome:

1. Flexible variable manipulation and expansion.
2. Functions can be written in shell or python.
3. Inline python to generate recipe code.
[[1](https://www.yoctoproject.org/docs/2.5/bitbake-user-manual/bitbake-user-manual.html#inline-python-variable-expansion)]
4. Dependency management between tasks.
[[2](https://www.yoctoproject.org/docs/2.5/bitbake-user-manual/bitbake-user-manual.html#dependencies)]

___

## recipe - bbappend

1. Append additional code to existing recipe.
2. Most commonly used with recipe from another layer.
3. '%' can be used as a wildcard as part of ${PV}.

```bash
# Typical recipe append paths:
${LAYERDIR}/recipes-${SECTION}/${PN}/${PN}_%.bbappend
${LAYERDIR}/recipes-${SECTION}/${PN}/${PN}_${PV}.bbappend
```

___


## recipe - bbclass

1. Inheritance for recipes.
2. Every recipe inherits `base.bbclass`.
3. Located in: `${LAYERDIR}/classes/`
4. Used with: `inherit my_class_name`

[[1](https://www.yoctoproject.org/docs/2.5/mega-manual/mega-manual.html#structure-meta-classes)]
[[2](https://www.yoctoproject.org/docs/2.5/mega-manual/mega-manual.html#ref-classes)]
[[3](https://www.yoctoproject.org/docs/2.5/bitbake-user-manual/bitbake-user-manual.html#inherit-configuration-directive)]

___

## recipe - inc

1. Code sharing between recipes.
2. Optional with: `include relpath/to.inc`
3. Required with: `require relpath/to.inc`
4. Often located near recipes they are used for.

[[1](https://www.yoctoproject.org/docs/2.5/bitbake-user-manual/bitbake-user-manual.html#include-directive)]
[[2](https://www.yoctoproject.org/docs/2.5/bitbake-user-manual/bitbake-user-manual.html#require-directive)]

